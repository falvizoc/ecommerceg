// =============================================================================
// eCommerce-G - Prisma Schema
// Multi-tenant eCommerce platform with SYSCOM integration
// =============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// =============================================================================
// MULTI-TENANT MODELS
// =============================================================================

model Tenant {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  domain    String?  @unique

  // Branding
  logo      String?
  favicon   String?

  // Business info
  legalName String?  @map("legal_name")
  rfc       String?

  // Settings (JSON)
  settings  Json     @default("{}")

  // Status
  isActive  Boolean  @default(true) @map("is_active")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  users           User[]
  pricing         TenantPricing?
  categoryMargins CategoryMargin[]
  productMargins  ProductMargin[]
  orders          Order[]
  customers       Customer[]

  @@map("tenants")
}

// =============================================================================
// AUTHENTICATION MODELS (NextAuth.js compatible)
// =============================================================================

model User {
  id            String    @id @default(uuid())
  email         String
  emailVerified DateTime? @map("email_verified")
  password      String?
  name          String?
  image         String?
  role          UserRole  @default(USER)

  // Multi-tenant
  tenantId      String?   @map("tenant_id")
  tenant        Tenant?   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  accounts      Account[]
  sessions      Session[]

  @@unique([email, tenantId])
  @@map("users")
}

model Account {
  id                String  @id @default(uuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

enum UserRole {
  SUPER_ADMIN  // Platform admin (can manage all tenants)
  ADMIN        // Tenant admin
  USER         // Regular user
}

// =============================================================================
// PRICING MODELS (Margin System)
// =============================================================================

model TenantPricing {
  id                 String     @id @default(uuid())
  tenantId           String     @unique @map("tenant_id")
  tenant             Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Default margin (fallback)
  defaultMarginType  MarginType @default(PERCENTAGE) @map("default_margin_type")
  defaultMarginValue Decimal    @default(25) @map("default_margin_value") @db.Decimal(10, 2)

  // Pricing strategy
  basePriceField     PriceField @default(PRECIO_ESPECIAL) @map("base_price_field")

  // Exchange rate settings
  useApiExchangeRate Boolean    @default(true) @map("use_api_exchange_rate")
  customExchangeRate Decimal?   @map("custom_exchange_rate") @db.Decimal(10, 4)

  // Timestamps
  createdAt          DateTime   @default(now()) @map("created_at")
  updatedAt          DateTime   @updatedAt @map("updated_at")

  @@map("tenant_pricing")
}

model CategoryMargin {
  id          String     @id @default(uuid())
  tenantId    String     @map("tenant_id")
  tenant      Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  categoryId  String     @map("category_id") // SYSCOM category ID
  marginType  MarginType @map("margin_type")
  marginValue Decimal    @map("margin_value") @db.Decimal(10, 2)

  // Timestamps
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")

  @@unique([tenantId, categoryId])
  @@map("category_margins")
}

model ProductMargin {
  id          String     @id @default(uuid())
  tenantId    String     @map("tenant_id")
  tenant      Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  productId   String     @map("product_id") // SYSCOM product ID
  marginType  MarginType @map("margin_type")
  marginValue Decimal?   @map("margin_value") @db.Decimal(10, 2)

  // Timestamps
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")

  @@unique([tenantId, productId])
  @@map("product_margins")
}

enum MarginType {
  PERCENTAGE      // +X% sobre costo
  FIXED_AMOUNT    // +$X sobre costo
  FIXED_PRICE     // Precio fijo ignorando costo
  LIST_DISCOUNT   // -X% sobre precio lista
  DISABLED        // No mostrar producto
}

enum PriceField {
  PRECIO_ESPECIAL // Precio distribuidor (costo)
  PRECIO_LISTA    // Precio sugerido (MSRP)
}

// =============================================================================
// CUSTOMER MODELS
// =============================================================================

model Customer {
  id        String   @id @default(uuid())
  tenantId  String   @map("tenant_id")
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Personal info
  email     String
  firstName String   @map("first_name")
  lastName  String   @map("last_name")
  phone     String?

  // Billing info (for CFDI)
  rfc       String?
  razonSocial String? @map("razon_social")
  usoCfdi   String?  @map("uso_cfdi")
  regimenFiscal String? @map("regimen_fiscal")
  codigoPostal String? @map("codigo_postal")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  addresses Address[]
  orders    Order[]

  @@unique([tenantId, email])
  @@map("customers")
}

model Address {
  id           String   @id @default(uuid())
  customerId   String   @map("customer_id")
  customer     Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  // Address fields
  type         AddressType @default(SHIPPING)
  firstName    String   @map("first_name")
  lastName     String   @map("last_name")
  company      String?
  street       String
  numExt       String   @map("num_ext")
  numInt       String?  @map("num_int")
  neighborhood String   // Colonia
  city         String
  state        String
  postalCode   String   @map("postal_code")
  country      String   @default("MX")
  phone        String?
  isDefault    Boolean  @default(false) @map("is_default")

  // Timestamps
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@map("addresses")
}

enum AddressType {
  SHIPPING
  BILLING
}

// =============================================================================
// ORDER MODELS
// =============================================================================

model Order {
  id             String      @id @default(uuid())
  orderNumber    String      @unique @map("order_number")
  tenantId       String      @map("tenant_id")
  tenant         Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customerId     String      @map("customer_id")
  customer       Customer    @relation(fields: [customerId], references: [id])

  // Status
  status         OrderStatus @default(PENDING)
  paymentStatus  PaymentStatus @default(PENDING) @map("payment_status")

  // Amounts
  subtotal       Decimal     @db.Decimal(12, 2)
  tax            Decimal     @db.Decimal(12, 2)
  shipping       Decimal     @default(0) @db.Decimal(12, 2)
  discount       Decimal     @default(0) @db.Decimal(12, 2)
  total          Decimal     @db.Decimal(12, 2)

  // Shipping info (snapshot)
  shippingAddress Json       @map("shipping_address")
  billingAddress  Json?      @map("billing_address")

  // SYSCOM order reference
  syscomOrderId  String?     @map("syscom_order_id")

  // Timestamps
  createdAt      DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @updatedAt @map("updated_at")
  paidAt         DateTime?   @map("paid_at")
  shippedAt      DateTime?   @map("shipped_at")
  deliveredAt    DateTime?   @map("delivered_at")

  // Relations
  items          OrderItem[]
  payments       Payment[]
  invoices       Invoice[]

  @@index([tenantId, status])
  @@index([tenantId, createdAt])
  @@map("orders")
}

model OrderItem {
  id             String   @id @default(uuid())
  orderId        String   @map("order_id")
  order          Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  // Product info (snapshot from SYSCOM)
  productId      String   @map("product_id") // SYSCOM product ID
  sku            String
  name           String
  image          String?

  // Pricing
  quantity       Int
  unitPrice      Decimal  @map("unit_price") @db.Decimal(12, 2)
  unitCost       Decimal  @map("unit_cost") @db.Decimal(12, 2) // Precio SYSCOM
  subtotal       Decimal  @db.Decimal(12, 2)

  // Timestamps
  createdAt      DateTime @default(now()) @map("created_at")

  @@map("order_items")
}

enum OrderStatus {
  PENDING       // Esperando pago
  CONFIRMED     // Pago confirmado
  PROCESSING    // Procesando con SYSCOM
  SHIPPED       // Enviado
  DELIVERED     // Entregado
  CANCELLED     // Cancelado
  REFUNDED      // Reembolsado
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

// =============================================================================
// PAYMENT MODELS
// =============================================================================

model Payment {
  id              String        @id @default(uuid())
  orderId         String        @map("order_id")
  order           Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)

  // Payment info
  provider        PaymentProvider
  method          String?       // card, oxxo, spei, etc.
  status          PaymentStatus
  amount          Decimal       @db.Decimal(12, 2)
  currency        String        @default("MXN")

  // Provider references
  externalId      String?       @map("external_id")
  externalData    Json?         @map("external_data")

  // 3D Secure
  threeDSecure    Boolean       @default(false) @map("three_d_secure")

  // Timestamps
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  @@map("payments")
}

enum PaymentProvider {
  MERCADOPAGO
  OPENPAY
  PAYPAL
  BANK_TRANSFER
}

// =============================================================================
// INVOICE MODELS (CFDI)
// =============================================================================

model Invoice {
  id              String        @id @default(uuid())
  orderId         String        @map("order_id")
  order           Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)

  // CFDI info
  uuid            String?       @unique // UUID del SAT
  serie           String?
  folio           String?
  status          InvoiceStatus @default(PENDING)

  // Customer billing info (snapshot)
  rfc             String
  razonSocial     String        @map("razon_social")
  usoCfdi         String        @map("uso_cfdi")
  regimenFiscal   String        @map("regimen_fiscal")
  codigoPostal    String        @map("codigo_postal")

  // Files (S3 URLs)
  xmlUrl          String?       @map("xml_url")
  pdfUrl          String?       @map("pdf_url")

  // Provider references
  facturapiId     String?       @map("facturapi_id")

  // Timestamps
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")
  stampedAt       DateTime?     @map("stamped_at")
  cancelledAt     DateTime?     @map("cancelled_at")

  @@map("invoices")
}

enum InvoiceStatus {
  PENDING
  STAMPED
  SENT
  CANCELLED
}
